import { z } from "zod";
import type { TextContent } from "@modelcontextprotocol/sdk/types.js";

export const findTraceTool = {
  name: "find_traces",
  description: "given parameters, return traces with specified structure",
  inputSchema: {
    service_name: z
      .string()
      .optional()
      .describe("service_name filters spans generated by a specific service."),
    operation_name: z
      .string()
      .optional()
      .describe(
        "operation_name filters spans by a specific operation / span name.",
      ),
    start_time_min: z
      .string()
      .optional()
      .describe(
        "start_time_min is the start of the time interval (inclusive) for the query. RFC-3339ns format (e.g., '2025-11-13T10:30:00Z'). If user says '30 minutes ago', convert to absolute timestamp. This field is required.",
      ),
    start_time_max: z
      .string()
      .optional()
      .describe(
        "start_time_max is the end of the time interval (exclusive) for the query. RFC-3339ns format (e.g., '2025-11-13T10:30:00Z'). If user says '30 minutes ago', this time is now. This field is required.",
      ),
    max_traces: z // differs from API "search_depth" for clarity
      .number()
      .int()
      .min(1)
      .max(200) // Maybe increase, 1000 or so, later?
      .optional()
      .describe(
        "Maximum number of traces to return (approximate). Defaults to 20. Higher values may result in slower responses and more data to analyze.",
      ),
  },
  outputSchema: { result: z.any() },
  handler: async (params: {
    service_name?: string;
    operation_name?: string;
    start_time_min?: string;
    start_time_max?: string;
    max_traces?: number;
  }) => {
    const jaegerUrl = process.env.URL;
    if (!jaegerUrl) {
      throw new Error("No URL environmental variable defined!");
    }

    // Handle default values for params
    const now = new Date();
    const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);
    const startTimeMin =
      params.start_time_min || thirtyMinutesAgo.toISOString();
    const startTimeMax = params.start_time_max || now.toISOString();

    const searchDepth = params.max_traces || 20;

    const queryParams = new URLSearchParams({
      "query.start_time_min": startTimeMin,
      "query.start_time_max": startTimeMax,
      "query.search_depth": searchDepth.toString(),
    });

    if (params.service_name) {
      queryParams.append("query.service_name", params.service_name);
    }
    if (params.operation_name) {
      queryParams.append("query.operation_name", params.operation_name);
    }

    // Build traces URL with query params
    const tracesUrl = `${jaegerUrl}/api/v3/traces?${queryParams.toString()}`;

    console.log(`Fetching sample trace from: ${tracesUrl}`);

    // Fetch raw data from Jaeger
    const response = await fetch(tracesUrl);
    const data = await response.json();

    // Log in docker
    console.log("=== Traces ===");
    console.log(JSON.stringify(data, null, 2));
    console.log("=======================");

    // TextContent is specified in the SDK docs to take a string literal 'text' for type and then just string for the text
    const textContent: TextContent = {
      type: "text",
      text: JSON.stringify(data, null, 2),
    };

    return {
      content: [textContent],
      structuredContent: { result: data },
    };
  },
};
