# Experimenting with running a distributed jaeger architecture with elasticsearch backend

networks:
  jaeger-test:
    driver: bridge

secrets: 
  slack_webhook: 
    file: ./slack_webhook.txt

services:
  # jaeger collector
  collector:
    image: jaegertracing/jaeger:2.11.0
    command: ["--config", "/etc/collector/config.yml"]
    volumes: 
      - ./collector/config.yml:/etc/collector/config.yml
    environment:
      - SPAN_STORAGE_TYPE=elasticsearch # not sure if needed
      - ES_SERVER_URLS=http://elasticsearch:9200 # not sure if needed
    ports:
      - "4317:4317"    # OTLP gRPC receiver
      - "4318:4318"    # OTLP HTTP receiver
      - "8889:8889"   # Prometheus metrics endpoint 
    networks:
      - jaeger-test
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped

# jaeger query service
  query:
    image: jaegertracing/jaeger:2.11.0
    command: ["--config", "/etc/query/config.yml"]
    volumes: 
      - ./query/config.yml:/etc/query/config.yml
      - ./query/config-ui.json:/etc/query/config-ui.json
    environment:
      - SPAN_STORAGE_TYPE=elasticsearch # not sure if needed
      - ES_SERVER_URLS=http://elasticsearch:9200 # not sure if needed
    ports:
      - "16686:16686"
    networks:
      - jaeger-test
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped


    

  # elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0 
    environment: 
      - discovery.type=single-node  # standalone instance setting 
      - xpack.security.enabled=false  # security feature disabled for convenience in local dev 
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m" # essentially keeps resource usage to 512 mb 
    ports: 
      - "9200:9200"
    networks: 
      - jaeger-test
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 60s

  prometheus:
    image: prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml
    ports:
      - "9090:9090"
    networks:
      - jaeger-test
    depends_on:
      - collector
    restart: unless-stopped

  # AlertManager - handles alerts from Prometheus
  alertmanager:
    image: prom/alertmanager:latest
    secrets: 
      - slack_webhook
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
    environment:
      - SLACK_WEBHOOK_URL_FILE=/run/secrets/slack_webhook
    volumes:  
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
  
    ports:
      - "9093:9093"
    networks:
      - jaeger-test
    restart: unless-stopped

  mcp:
    image: philipsknapp/jaeger_mcp_test
    platform: linux/amd64
    environment:
      - URL=http://query:16686/api/v3/services
    ports:
      - "3000:3000"
    networks:
      - jaeger-test
    depends_on:
      query:
        condition: service_started
    

# HotROD demo application - generates trace data
  hotrod:
    image: jaegertracing/example-hotrod:latest
    ports:
      - "8080:8080"
      - "8083:8083"
    command: ["all"]
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:4318
    networks:
      - jaeger-test
    depends_on:
      - collector
    restart: unless-stopped